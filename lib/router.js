// Generated by CoffeeScript 1.7.1
(function() {
  var Request, Response, Router, async, backbone, inflection, p, router, _;

  _ = require('lodash');

  async = require('async');

  inflection = require('inflection');

  Request = require('./request');

  Response = require('./response');

  backbone = require('./backbone');

  p = require('path');

  Router = (function() {
    var _parseDsl;

    function Router(app) {
      this.app = app;
    }

    Router.prototype.middlewares = [];

    Router.prototype.prefix = null;

    Router.prototype._resource = function(ctrl) {
      ctrl = inflection.pluralize(ctrl);
      return {
        readOne: {
          method: 'get',
          path: "/" + ctrl + "/:_id"
        },
        read: {
          method: 'get',
          path: "/" + ctrl
        },
        create: {
          method: 'post',
          path: "/" + ctrl
        },
        update: {
          method: 'put',
          path: "/" + ctrl + "/:_id"
        },
        remove: {
          method: 'delete',
          path: "/" + ctrl + "/:_id"
        }
      };
    };

    _parseDsl = function(path, options) {
      var action, ctrl, to, _ref;
      if (options == null) {
        options = {};
      }
      if (arguments.length === 2) {
        options.path = path;
        to = options.to;
        if (to != null) {
          _ref = to.split('#'), ctrl = _ref[0], action = _ref[1];
          action || (action = 'index');
          options.ctrl || (options.ctrl = ctrl);
          options.action || (options.action = action);
        }
      } else {
        options = path;
      }
      return options;
    };

    Router.prototype.callback = function(req, res) {
      return res.json();
    };

    Router.prototype.resource = function(ctrl, options) {
      var action, except, map, only, opt, _options, _results;
      if (options == null) {
        options = {};
      }
      map = this._resource(ctrl);
      only = options.only, except = options.except;
      if (only != null) {
        map = _.pick(map, only);
      } else if (except != null) {
        map = _.omit(map, except);
      }
      _results = [];
      for (action in map) {
        opt = map[action];
        _options = _.extend(options, {
          ctrl: ctrl,
          action: action,
          method: opt.method,
          path: opt.path
        });
        _results.push(this._apply(_options));
      }
      return _results;
    };

    Router.prototype.get = function() {
      var options;
      options = _parseDsl.apply(this, arguments);
      options.method = 'get';
      return this._apply(options);
    };

    Router.prototype.post = function() {
      var options;
      options = _parseDsl.apply(this, arguments);
      options.method = 'post';
      return this._apply(options);
    };

    Router.prototype.put = function() {
      var options;
      options = _parseDsl.apply(this, arguments);
      options.method = 'put';
      return this._apply(options);
    };

    Router.prototype["delete"] = function() {
      var options;
      options = _parseDsl.apply(this, arguments);
      options.method = 'delete';
      return this._apply(options);
    };

    Router.prototype.options = function() {
      var options;
      options = _parseDsl.apply(this, arguments);
      options.method = 'options';
      return this._apply(options);
    };

    Router.prototype._apply = function(options) {
      var $ctrl, action, callback, ctrl, method, middlewares, path, sundae;
      if (options == null) {
        options = {};
      }
      ctrl = options.ctrl, action = options.action, method = options.method, path = options.path, middlewares = options.middlewares, callback = options.callback;
      middlewares || (middlewares = this.middlewares);
      callback || (callback = this.callback);
      action || (action = 'index');
      sundae = require('./sundae');
      $ctrl = require(p.join(sundae.get('mainPath'), "controllers/" + ctrl));
      if (typeof $ctrl[action] !== 'function') {
        return false;
      }
      if (typeof path === 'string' && this.prefix) {
        path = '/' + p.join(this.prefix, path);
      }
      return this.app[method](path, function(req, res) {
        var params, _req, _res;
        params = _.extend(req.headers, req.cookies, req.params, req.query, req.body, req.session);
        params.session = req.session;
        params.cookies = req.cookies;
        _req = new Request(params);
        _req.$ctrl = $ctrl;
        _req.ctrl = ctrl;
        _req.action = action;
        _req.middlewares = middlewares;
        _res = new Response({
          res: res
        });
        return backbone(_req, _res, callback);
      });
    };

    return Router;

  })();

  router = function(app) {
    return new Router(app);
  };

  module.exports = router;

}).call(this);
